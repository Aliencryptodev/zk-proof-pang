<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ZK Proof Pang - Web3 Adventure Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            font-family: 'Orbitron', monospace;
            overflow: hidden;
            position: relative;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            border: 3px solid #5e548e;
            box-shadow: 0 0 30px rgba(94, 84, 142, 0.5);
            display: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        #menuScreen, #characterSelect, #gameOverScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 10;
        }

        #menuScreen {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(15, 52, 96, 0.95) 100%);
            padding: 50px;
            border-radius: 30px;
            border: 3px solid #5e548e;
            box-shadow: 0 0 50px rgba(94, 84, 142, 0.7);
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(135deg, #e94560 0%, #5e548e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: 20px;
            color: #00bcd4;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .description {
            font-size: 14px;
            color: #f39c12;
            margin-bottom: 40px;
            line-height: 1.6;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        button {
            background: linear-gradient(135deg, #e94560 0%, #5e548e 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
            animation: pulse 2s infinite;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.6);
            background: linear-gradient(135deg, #ff5777 0%, #6e5e9e 100%);
        }

        button:active {
            transform: translateY(0);
        }

        #characterSelect {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(15, 52, 96, 0.98) 100%);
            padding: 40px;
            border-radius: 30px;
            border: 3px solid #5e548e;
            box-shadow: 0 0 50px rgba(94, 84, 142, 0.7);
            display: none;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .characters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .character-card {
            background: linear-gradient(135deg, rgba(94, 84, 142, 0.3) 0%, rgba(15, 52, 96, 0.3) 100%);
            border: 2px solid #5e548e;
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #e94560, #5e548e, #00bcd4, #f39c12);
            border-radius: 20px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
            background-size: 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(94, 84, 142, 0.5);
        }

        .character-card:hover::before {
            opacity: 1;
        }

        .character-preview {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: #333;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .character-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #e94560;
        }

        .character-ability {
            font-size: 12px;
            color: #00bcd4;
            margin-bottom: 5px;
        }

        #gameOverScreen {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(15, 52, 96, 0.98) 100%);
            padding: 40px;
            border-radius: 30px;
            border: 3px solid #5e548e;
            box-shadow: 0 0 50px rgba(94, 84, 142, 0.7);
            display: none;
            min-width: 400px;
        }

        .score-display {
            font-size: 24px;
            margin: 15px 0;
            color: #00bcd4;
        }

        #fullscreenBtn, #soundBtn {
            position: fixed;
            top: 10px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #5e548e 0%, #0f3460 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            z-index: 1001;
            display: none;
            transition: all 0.3s ease;
        }

        #fullscreenBtn {
            right: 10px;
        }

        #soundBtn {
            right: 140px;
        }

        #fullscreenBtn:hover, #soundBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(94, 84, 142, 0.5);
        }

        .hud {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 100;
            display: none;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #5e548e;
        }

        .hud div {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            h1 { font-size: 48px; }
            .subtitle { font-size: 16px; }
            .character-card { padding: 15px; }
            .characters { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            #gameOverScreen { min-width: 90vw; padding: 20px; }
        }

        /* Mobile controls styles */
        #mobileControls button {
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        #mobileControls button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Tutorial styles */
        #tutorial button {
            animation: pulse 1.5s infinite;
        }

        /* Pause menu animation */
        #pauseMenu {
            animation: fadeIn 0.3s ease-in;
        }

        /* Share button styles */
        .share-button {
            background: linear-gradient(135deg, #1DA1F2 0%, #0e71c8 100%) !important;
            margin-top: 15px;
        }

        .share-button:hover {
            background: linear-gradient(135deg, #2cafff 0%, #1289ea 100%) !important;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="menuScreen">
        <h1>ZK PROOF PANG</h1>
        <p class="subtitle">üîê The Ultimate Web3 Adventure üöÄ</p>
        <p class="description">
            Join the cryptographic heroes in their quest to destroy the malicious data bubbles 
            threatening the blockchain! Each character has unique abilities powered by zero-knowledge proofs.
        </p>
        <button onclick="showCharacterSelect()">START GAME</button>
    </div>

    <div id="characterSelect">
        <h2 style="color: #e94560; font-size: 36px; margin-bottom: 20px;">Select Your Prover</h2>
        <div class="characters">
            <div class="character-card" onclick="selectCharacter(1)">
                <div class="character-preview" style="background: #3498db;">üîµ</div>
                <div class="character-name">Blue Prover</div>
                <div class="character-ability">Standard abilities</div>
                <div class="character-ability">Balanced gameplay</div>
            </div>
            <div class="character-card" onclick="selectCharacter(2)">
                <div class="character-preview" style="background: #2ecc71;">üü¢</div>
                <div class="character-name">Green Prover</div>
                <div class="character-ability">Double jump ability</div>
                <div class="character-ability">Enhanced mobility</div>
            </div>
            <div class="character-card" onclick="selectCharacter(3)">
                <div class="character-preview" style="background: #9b59b6;">üü£</div>
                <div class="character-name">Purple Prover</div>
                <div class="character-ability">Rapid fire shooting</div>
                <div class="character-ability">High DPS</div>
            </div>
            <div class="character-card" onclick="selectCharacter(4)">
                <div class="character-preview" style="background: #ff69b4;">ü©∑</div>
                <div class="character-name">Pink Prover</div>
                <div class="character-ability">Slows down time</div>
                <div class="character-ability">Precision gameplay</div>
            </div>
            <div class="character-card" onclick="selectCharacter(5)">
                <div class="character-preview" style="background: #ff6b35;">üü†</div>
                <div class="character-name">Orange Prover</div>
                <div class="character-ability">2x score multiplier</div>
                <div class="character-ability">High risk, high reward</div>
            </div>
        </div>
        <button onclick="backToMenu()" style="background: linear-gradient(135deg, #7f8c8d 0%, #34495e 100%); margin-top: 20px;">BACK</button>
    </div>

    <div id="gameOverScreen">
        <h2 id="gameOverTitle" style="color: #e94560; font-size: 36px; margin-bottom: 20px;">GAME OVER</h2>
        <div id="finalScore" class="score-display"></div>
        <div id="finalLevel" class="score-display"></div>
        <div id="finalTime" class="score-display"></div>
        <button id="restartBtn" onclick="location.reload()">PLAY AGAIN</button>
        <button onclick="shareOnTwitter()" class="share-button">üê¶ SHARE ON TWITTER</button>
    </div>

    <div class="hud" id="gameHUD">
        <div>üéØ Score: <span id="scoreDisplay">0</span></div>
        <div>üåç Level: <span id="levelDisplay">1</span></div>
        <div>‚ù§Ô∏è Lives: <span id="livesDisplay">3</span></div>
        <div>üî´ Ammo: <span id="ammoDisplay">‚àû</span></div>
    </div>

    <button id="fullscreenBtn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    <button id="soundBtn" onclick="toggleSoundButton()">üîä Sound</button>

    <script>
        // Game configuration
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game constants
        const GRAVITY = 0.5;
        const MAX_LIVES = 3;
        const BALL_COLORS = ['#e94560', '#00bcd4', '#f39c12', '#2ecc71', '#9b59b6'];
        
        // World themes
        const WORLDS = {
            1: { name: 'Crypto City', background: '#1a1a2e' },
            2: { name: 'Merkle Forest', background: '#0f4c5c' },
            3: { name: 'Hash Cavern', background: '#2d1b69' },
            4: { name: 'Zero-Knowledge Space', background: '#0a0e27' },
            5: { name: 'Blockchain Fortress', background: '#3e1f47' }
        };
        
        // Power-up types
        const POWERUP_TYPES = {
            SLOW_TIME: { symbol: '‚è±Ô∏è', color: '#00bcd4', duration: 5000 },
            RAPID_FIRE: { symbol: 'üî•', color: '#e94560', duration: 7000 },
            SHIELD: { symbol: 'üõ°Ô∏è', color: '#f39c12', duration: 10000 },
            DOUBLE_POINTS: { symbol: 'üíé', color: '#9b59b6', duration: 8000 },
            FREEZE: { symbol: '‚ùÑÔ∏è', color: '#3498db', duration: 3000 },
            EXPLOSIVE: { symbol: 'üí•', color: '#e74c3c', duration: 5000 }
        };
        
        // Level configurations
        const LEVEL_CONFIGS = [
            // World 1: Crypto City (Levels 1-4)
            { balls: 1, sizes: [4], speed: 1, powerupChance: 0.3 },
            { balls: 2, sizes: [3, 4], speed: 1.1, powerupChance: 0.35 },
            { balls: 2, sizes: [4, 4], speed: 1.2, powerupChance: 0.4 },
            { balls: 3, sizes: [3, 3, 4], speed: 1.3, powerupChance: 0.45 },
            
            // World 2: Merkle Forest (Levels 5-8)
            { balls: 3, sizes: [3, 4, 4], speed: 1.4, powerupChance: 0.4 },
            { balls: 4, sizes: [2, 3, 3, 4], speed: 1.5, powerupChance: 0.45 },
            { balls: 4, sizes: [3, 3, 4, 4], speed: 1.6, powerupChance: 0.5 },
            { balls: 5, sizes: [2, 2, 3, 3, 4], speed: 1.7, powerupChance: 0.55 },
            
            // World 3: Hash Cavern (Levels 9-12)
            { balls: 5, sizes: [2, 3, 3, 4, 4], speed: 1.8, powerupChance: 0.5 },
            { balls: 6, sizes: [2, 2, 3, 3, 3, 4], speed: 1.9, powerupChance: 0.55 },
            { balls: 6, sizes: [2, 3, 3, 3, 4, 4], speed: 2.0, powerupChance: 0.6 },
            { balls: 7, sizes: [2, 2, 2, 3, 3, 3, 4], speed: 2.1, powerupChance: 0.65 },
            
            // World 4: Zero-Knowledge Space (Levels 13-16)
            { balls: 7, sizes: [2, 2, 3, 3, 3, 4, 4], speed: 2.2, powerupChance: 0.6 },
            { balls: 8, sizes: [1, 2, 2, 3, 3, 3, 4, 4], speed: 2.3, powerupChance: 0.65 },
            { balls: 8, sizes: [2, 2, 2, 3, 3, 3, 4, 4], speed: 2.4, powerupChance: 0.7 },
            { balls: 9, sizes: [1, 1, 2, 2, 3, 3, 3, 4, 4], speed: 2.5, powerupChance: 0.75 },
            
            // World 5: Blockchain Fortress (Levels 17-20)
            { balls: 9, sizes: [1, 2, 2, 2, 3, 3, 3, 4, 4], speed: 2.6, powerupChance: 0.7 },
            { balls: 10, sizes: [1, 1, 2, 2, 2, 3, 3, 3, 4, 4], speed: 2.7, powerupChance: 0.75 },
            { balls: 10, sizes: [1, 1, 1, 2, 2, 3, 3, 3, 4, 4], speed: 2.8, powerupChance: 0.8 },
            { balls: 12, sizes: [1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4], speed: 3.0, powerupChance: 0.85 }
        ];
        
        // Game state variables
        let gameRunning = false;
        let gameWon = false;
        let level = 1;
        let score = 0;
        let highScore = localStorage.getItem('zkPangHighScore') || 0;
        let lives = MAX_LIVES;
        let currentWorld = 1;
        let activePowerup = null;
        let powerupEndTime = 0;
        let slowTimeMultiplier = 1;
        let scoreMultiplier = 1;
        let shieldActive = false;
        let explosiveBullets = false;
        let frozenBalls = false;
        let frozenEndTime = 0;
        let levelStarted = false;
        let gameStartTime = 0;
        let totalGameTime = 0;
        
        // Game objects
        let player = null;
        let balls = [];
        let bullets = [];
        let powerups = [];
        let platforms = [];
        let backgroundImage = null;

        // ==================== SOUND SYSTEM ====================
        let soundEnabled = true;
        let audioContext = null;

        // Initialize audio context on first user interaction
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Create sound effects
        function createSound(frequency, duration, type = 'square', volume = 0.3) {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Define all game sounds
        const sounds = {
            shoot: () => createSound(800, 0.1, 'square', 0.2),
            hit: () => createSound(200, 0.3, 'sawtooth', 0.3),
            powerup: () => createSound(600, 0.5, 'sine', 0.4),
            jump: () => createSound(400, 0.2, 'triangle', 0.3),
            gameOver: () => createSound(100, 1, 'sawtooth', 0.4),
            levelComplete: () => {
                // Victory melody
                setTimeout(() => createSound(523, 0.2, 'sine', 0.3), 0);
                setTimeout(() => createSound(659, 0.2, 'sine', 0.3), 200);
                setTimeout(() => createSound(784, 0.2, 'sine', 0.3), 400);
                setTimeout(() => createSound(1047, 0.3, 'sine', 0.4), 600);
            },
            pause: () => createSound(300, 0.2, 'sine', 0.2)
        };

        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName]();
            }
        }

        // ==================== PAUSE SYSTEM ====================
        let isPaused = false;
        let pauseMenu = null;

        function createPauseMenu() {
            pauseMenu = document.createElement('div');
            pauseMenu.id = 'pauseMenu';
            pauseMenu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(15, 52, 96, 0.98) 100%);
                border: 3px solid #5e548e;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                z-index: 2000;
                display: none;
                box-shadow: 0 0 50px rgba(94, 84, 142, 0.5);
            `;
            
            pauseMenu.innerHTML = `
                <h2 style="color: #e94560; font-size: 36px; margin-bottom: 20px;">PAUSED</h2>
                <p style="color: #00bcd4; margin-bottom: 30px;">Press P or ESC to resume</p>
                <div style="text-align: left; color: #f39c12; line-height: 1.8;">
                    <h3 style="text-align: center; margin-bottom: 15px;">Controls:</h3>
                    <p>‚Üê ‚Üí or A/D: Move</p>
                    <p>‚Üë or W: Jump</p>
                    <p>SPACE: Shoot</p>
                    <p>P or ESC: Pause</p>
                    <p>S: Toggle Sound</p>
                </div>
                <button onclick="resumeGame()" style="
                    margin-top: 30px;
                    padding: 15px 30px;
                    background: linear-gradient(135deg, #e94560 0%, #5e548e 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 20px;
                    cursor: pointer;
                    font-family: 'Orbitron', monospace;
                ">RESUME GAME</button>
            `;
            
            document.body.appendChild(pauseMenu);
        }

        function togglePause() {
            if (!gameRunning) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                playSound('pause');
                pauseMenu.style.display = 'block';
            } else {
                pauseMenu.style.display = 'none';
            }
        }

        function resumeGame() {
            isPaused = false;
            pauseMenu.style.display = 'none';
        }

        // ==================== VISUAL EFFECTS ====================
        const particles = [];

        class Particle {
            constructor(x, y, color, vx, vy, size = 3) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.size = size;
                this.life = 1;
                this.decay = 0.02;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2; // gravity
                this.life -= this.decay;
                this.size *= 0.98;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                ctx.restore();
            }
        }

        function createExplosion(x, y, color, count = 20) {
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count;
                const speed = 2 + Math.random() * 4;
                particles.push(new Particle(
                    x, y, color,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed,
                    2 + Math.random() * 4
                ));
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.update();
                
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                } else {
                    particle.draw();
                }
            }
        }

        // ==================== MOBILE CONTROLS ====================
        let touchStartX = 0;
        let touchStartY = 0;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        function createMobileControls() {
            if (!isMobile) return;
            
            const controlsDiv = document.createElement('div');
            controlsDiv.id = 'mobileControls';
            controlsDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 0;
                right: 0;
                display: none;
                z-index: 1000;
                user-select: none;
                -webkit-user-select: none;
            `;
            
            controlsDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; padding: 0 20px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="leftBtn" style="width: 60px; height: 60px; font-size: 24px; background: rgba(94, 84, 142, 0.7); border: 2px solid #5e548e; color: white; border-radius: 10px;">‚Üê</button>
                        <button id="rightBtn" style="width: 60px; height: 60px; font-size: 24px; background: rgba(94, 84, 142, 0.7); border: 2px solid #5e548e; color: white; border-radius: 10px;">‚Üí</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="jumpBtn" style="width: 60px; height: 60px; font-size: 24px; background: rgba(0, 188, 212, 0.7); border: 2px solid #00bcd4; color: white; border-radius: 10px;">‚Üë</button>
                        <button id="shootBtn" style="width: 80px; height: 60px; font-size: 20px; background: rgba(233, 69, 96, 0.7); border: 2px solid #e94560; color: white; border-radius: 10px;">FIRE</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(controlsDiv);
            
            // Touch events
            document.getElementById('leftBtn').addEventListener('touchstart', () => keys['ArrowLeft'] = true);
            document.getElementById('leftBtn').addEventListener('touchend', () => keys['ArrowLeft'] = false);
            
            document.getElementById('rightBtn').addEventListener('touchstart', () => keys['ArrowRight'] = true);
            document.getElementById('rightBtn').addEventListener('touchend', () => keys['ArrowRight'] = false);
            
            document.getElementById('jumpBtn').addEventListener('touchstart', () => keys['ArrowUp'] = true);
            document.getElementById('jumpBtn').addEventListener('touchend', () => keys['ArrowUp'] = false);
            
            document.getElementById('shootBtn').addEventListener('touchstart', () => keys[' '] = true);
            document.getElementById('shootBtn').addEventListener('touchend', () => keys[' '] = false);
        }

        // ==================== TUTORIAL SYSTEM ====================
        let tutorialStep = 0;
        let showTutorial = true;

        function createTutorial() {
            const tutorial = document.createElement('div');
            tutorial.id = 'tutorial';
            tutorial.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                padding: 20px;
                border-radius: 10px;
                border: 2px solid #00bcd4;
                color: white;
                font-size: 18px;
                z-index: 1500;
                max-width: 400px;
                text-align: center;
                display: none;
            `;
            
            document.body.appendChild(tutorial);
        }

        const tutorialSteps = [
            "Welcome to ZK Proof Pang! Use ‚Üê ‚Üí to move",
            "Press ‚Üë or W to jump on platforms",
            "Press SPACE to shoot and destroy the balls",
            "Collect power-ups for special abilities!",
            "Destroy all balls to complete the level!"
        ];

        function showTutorialStep() {
            if (!showTutorial || tutorialStep >= tutorialSteps.length) {
                document.getElementById('tutorial').style.display = 'none';
                return;
            }
            
            const tutorial = document.getElementById('tutorial');
            tutorial.innerHTML = `
                <h3 style="color: #00bcd4; margin-bottom: 10px;">Tutorial ${tutorialStep + 1}/${tutorialSteps.length}</h3>
                <p>${tutorialSteps[tutorialStep]}</p>
                <button onclick="nextTutorialStep()" style="
                    margin-top: 15px;
                    padding: 10px 20px;
                    background: #00bcd4;
                    border: none;
                    border-radius: 5px;
                    color: white;
                    cursor: pointer;
                ">Next ‚Üí</button>
            `;
            tutorial.style.display = 'block';
        }

        function nextTutorialStep() {
            tutorialStep++;
            showTutorialStep();
        }

        // ==================== GAME CLASSES ====================
        
        // Player class
        class Player {
            constructor(id, color, spriteType = null) {
                this.id = id;
                this.x = canvas.width / 2 - 15;
                this.y = canvas.height - 100;
                this.width = 30;
                this.height = 40;
                this.vx = 0;
                this.vy = 0;
                this.speed = 5;
                this.jumpSpeed = -15;
                this.color = color;
                this.spriteType = spriteType;
                this.canShoot = true;
                this.shootCooldown = 300;
                this.lastShot = 0;
                this.onGround = false;
                this.doubleJumpAvailable = false;
                this.ammo = Infinity;
                
                // Character-specific abilities
                this.setupAbilities();
            }
            
            setupAbilities() {
                switch(this.id) {
                    case 2: // Green - Double jump
                        this.doubleJumpAvailable = true;
                        break;
                    case 3: // Purple - Rapid fire
                        this.shootCooldown = 150;
                        break;
                    case 4: // Pink - Slow time
                        // Handled in main game logic
                        break;
                    case 5: // Orange - Double points
                        scoreMultiplier = 2;
                        break;
                }
            }
            
            update() {
                // Horizontal movement
                if ((keys['a'] || keys['A'] || keys['ArrowLeft']) && this.x > 0) {
                    this.vx = -this.speed;
                } else if ((keys['d'] || keys['D'] || keys['ArrowRight']) && this.x < canvas.width - this.width) {
                    this.vx = this.speed;
                } else {
                    this.vx *= 0.8;
                }
                
                // Jump
                if ((keys['w'] || keys['W'] || keys['ArrowUp']) && this.onGround) {
                    this.vy = this.jumpSpeed;
                    this.onGround = false;
                    playSound('jump');
                    if (this.id === 2) {
                        this.doubleJumpAvailable = true;
                    }
                } else if (this.id === 2 && (keys['w'] || keys['W'] || keys['ArrowUp']) && 
                         this.doubleJumpAvailable && !this.onGround) {
                    this.vy = this.jumpSpeed;
                    this.doubleJumpAvailable = false;
                    playSound('jump');
                }
                
                // Apply physics
                this.x += this.vx;
                this.vy += GRAVITY;
                this.y += this.vy;
                
                // Ground collision
                if (this.y > canvas.height - 100) {
                    this.y = canvas.height - 100;
                    this.vy = 0;
                    this.onGround = true;
                }
                
                // Platform collision
                platforms.forEach(platform => {
                    if (this.vy > 0 &&
                        this.x < platform.x + platform.width &&
                        this.x + this.width > platform.x &&
                        this.y < platform.y &&
                        this.y + this.height > platform.y) {
                        this.y = platform.y - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                });
                
                // Shooting
                if (keys[' '] && this.canShoot) {
                    this.shoot();
                }
            }
            
            shoot() {
                const now = Date.now();
                if (now - this.lastShot > this.shootCooldown && this.ammo > 0) {
                    playSound('shoot');
                    bullets.push(new Bullet(
                        this.x + this.width / 2,
                        this.y,
                        explosiveBullets
                    ));
                    this.lastShot = now;
                    if (this.ammo !== Infinity) {
                        this.ammo--;
                    }
                }
            }
            
            draw() {
                // Draw character
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Draw character details
                ctx.fillStyle = 'white';
                ctx.fillRect(this.x + 5, this.y + 5, 5, 5);
                ctx.fillRect(this.x + 20, this.y + 5, 5, 5);
                ctx.fillRect(this.x + 10, this.y + 25, 10, 3);
                
                // Shield effect
                if (shieldActive) {
                    ctx.strokeStyle = 'rgba(243, 156, 18, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, 30, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }
        
        // Ball class
        class Ball {
            constructor(x, y, size, speedMultiplier = 1) {
                this.x = x;
                this.y = y;
                this.size = size;
                this.radius = size * 10;
                this.vx = (Math.random() - 0.5) * 4 * speedMultiplier;
                this.vy = Math.random() * -5;
                this.color = BALL_COLORS[Math.floor(Math.random() * BALL_COLORS.length)];
                this.frozen = false;
            }
            
            update() {
                if (this.frozen) return;
                
                this.vx *= slowTimeMultiplier;
                this.vy *= slowTimeMultiplier;
                
                this.x += this.vx;
                this.vy += GRAVITY * slowTimeMultiplier;
                this.y += this.vy;
                
                // Bounce off walls
                if (this.x - this.radius < 0 || this.x + this.radius > canvas.width) {
                    this.vx = -this.vx;
                }
                
                // Bounce off ground
                if (this.y + this.radius > canvas.height - 60) {
                    this.y = canvas.height - 60 - this.radius;
                    this.vy = -Math.abs(this.vy) * 0.8;
                }
                
                // Restore normal time
                this.vx /= slowTimeMultiplier;
                this.vy /= slowTimeMultiplier;
            }
            
            draw() {
                ctx.fillStyle = this.frozen ? '#87CEEB' : this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Frozen effect
                if (this.frozen) {
                    ctx.strokeStyle = 'rgba(135, 206, 235, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            }
        }
        
        // Bullet class
        class Bullet {
            constructor(x, y, explosive = false) {
                this.x = x;
                this.y = y;
                this.width = 4;
                this.height = 20;
                this.speed = 10;
                this.explosive = explosive;
            }
            
            update() {
                this.y -= this.speed;
            }
            
            draw() {
                ctx.fillStyle = this.explosive ? '#e74c3c' : '#ffffff';
                ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height);
                
                if (this.explosive) {
                    ctx.shadowColor = '#e74c3c';
                    ctx.shadowBlur = 10;
                    ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height);
                    ctx.shadowBlur = 0;
                }
            }
        }
        
        // PowerUp class
        class PowerUp {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.type = Object.keys(POWERUP_TYPES)[Math.floor(Math.random() * Object.keys(POWERUP_TYPES).length)];
                this.vy = 2;
                this.collected = false;
            }
            
            update() {
                this.y += this.vy;
                if (this.y > canvas.height) {
                    this.collected = true;
                }
            }
            
            draw() {
                const powerup = POWERUP_TYPES[this.type];
                ctx.fillStyle = powerup.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(powerup.symbol, this.x + this.width/2, this.y + this.height/2 + 7);
            }
        }
        
        // Platform class
        class Platform {
            constructor(x, y, width, height) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
            }
            
            draw() {
                ctx.fillStyle = '#5e548e';
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        // ==================== GAME FUNCTIONS ====================
        
        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            
            // Pause controls
            if (e.key === 'p' || e.key === 'P' || e.key === 'Escape') {
                togglePause();
            }
            
            // Sound toggle
            if (e.key === 's' || e.key === 'S') {
                soundEnabled = !soundEnabled;
                console.log('Sound:', soundEnabled ? 'ON' : 'OFF');
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // Menu functions
        function showCharacterSelect() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('characterSelect').style.display = 'block';
        }
        
        function backToMenu() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'block';
        }
        
        function selectCharacter(id) {
            const colors = ['', '#3498db', '#2ecc71', '#9b59b6', '#ff69b4', '#ff6b35'];
            const color = colors[id];
            startGame(id, color);
        }
        
        // Initialize game
        function startGame(id, color, spriteType = null) {
            initAudio();
            createPauseMenu();
            createTutorial();
            createMobileControls();
            
            gameStartTime = Date.now();
            
            // Hide menus and show game
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameHUD').style.display = 'block';
            document.getElementById('fullscreenBtn').style.display = 'block';
            document.getElementById('soundBtn').style.display = 'block';
            
            // Show mobile controls if needed
            if (isMobile && document.getElementById('mobileControls')) {
                document.getElementById('mobileControls').style.display = 'block';
            }
            
            // Show tutorial on first level
            if (level === 1) {
                setTimeout(() => showTutorialStep(), 1000);
            }
            
            // Initialize game objects
            player = new Player(id, color, spriteType);
            createLevel();
            gameRunning = true;
            
            // Start pink character ability
            if (id === 4) {
                slowTimeMultiplier = 0.7;
            }
            
            // Load background
            loadBackground();
            
            // Start game loop
            gameLoop();
        }
        
        // Create level
        function createLevel() {
            balls = [];
            bullets = [];
            powerups = [];
            platforms = [];
            
            // Create platforms
            platforms.push(new Platform(100, 450, 150, 20));
            platforms.push(new Platform(350, 350, 100, 20));
            platforms.push(new Platform(550, 450, 150, 20));
            platforms.push(new Platform(200, 250, 120, 20));
            platforms.push(new Platform(480, 250, 120, 20));
            
            // Create balls
            const config = LEVEL_CONFIGS[level - 1];
            for (let i = 0; i < config.balls; i++) {
                const x = 100 + (canvas.width - 200) / config.balls * i + Math.random() * 50;
                const y = 100 + Math.random() * 100;
                balls.push(new Ball(x, y, config.sizes[i], config.speed));
            }
            
            levelStarted = true;
        }
        
        // Load background
        function loadBackground() {
            currentWorld = Math.ceil(level / 4);
            const worldData = WORLDS[currentWorld];
            
            // Try to load background image
            backgroundImage = new Image();
            backgroundImage.onload = function() {
                console.log('Background loaded:', worldData.name);
            };
            backgroundImage.onerror = function() {
                console.log('Background failed to load, using color');
                backgroundImage = null;
            };
            
            const backgroundMap = {
                'Crypto City': 'crypto-city.png',
                'Merkle Forest': 'merkle-forest.png',
                'Hash Cavern': 'hash-cavern.png',
                'Zero-Knowledge Space': 'zero-knowledge-space.png',
                'Blockchain Fortress': 'blockchain-fortress.png'
            };
            
            backgroundImage.src = `assets/backgrounds/${backgroundMap[worldData.name]}`;
        }
        
        // Split ball
        function splitBall(ball, explosive = false) {
            playSound('hit');
            createExplosion(ball.x, ball.y, ball.color);
            
            const index = balls.indexOf(ball);
            if (index > -1) {
                balls.splice(index, 1);
            }
            
            // Add score
            score += ball.size * 100 * scoreMultiplier;
            updateHUD();
            
            // Create smaller balls
            if (ball.size > 1) {
                const newSize = ball.size - 1;
                const speedBoost = 1.2;
                
                const ball1 = new Ball(ball.x - 20, ball.y, newSize, speedBoost);
                const ball2 = new Ball(ball.x + 20, ball.y, newSize, speedBoost);
                
                ball1.vx = -Math.abs(ball.vx) * 1.5;
                ball2.vx = Math.abs(ball.vx) * 1.5;
                ball1.vy = -10;
                ball2.vy = -10;
                
                balls.push(ball1, ball2);
                
                // Explosive bullets destroy nearby balls
                if (explosive) {
                    balls.forEach(b => {
                        const dist = Math.sqrt(Math.pow(b.x - ball.x, 2) + Math.pow(b.y - ball.y, 2));
                        if (dist < 100 && b !== ball1 && b !== ball2) {
                            splitBall(b);
                        }
                    });
                }
            }
            
            // Random power-up drop
            const config = LEVEL_CONFIGS[level - 1];
            if (Math.random() < config.powerupChance) {
                powerups.push(new PowerUp(ball.x, ball.y));
            }
            
            // Check level complete
            if (balls.length === 0) {
                levelComplete();
            }
        }
        
        // Apply power-up
        function applyPowerup(type) {
            playSound('powerup');
            createExplosion(player.x + player.width/2, player.y + player.height/2, '#FFD700', 30);
            
            activePowerup = type;
            powerupEndTime = Date.now() + POWERUP_TYPES[type].duration;
            
            switch(type) {
                case 'SLOW_TIME':
                    slowTimeMultiplier = 0.5;
                    break;
                case 'RAPID_FIRE':
                    player.shootCooldown = 100;
                    break;
                case 'SHIELD':
                    shieldActive = true;
                    break;
                case 'DOUBLE_POINTS':
                    scoreMultiplier = 2;
                    break;
                case 'FREEZE':
                    frozenBalls = true;
                    frozenEndTime = Date.now() + POWERUP_TYPES[type].duration;
                    balls.forEach(ball => ball.frozen = true);
                    break;
                case 'EXPLOSIVE':
                    explosiveBullets = true;
                    break;
            }
        }
        
        // Check collisions
        function checkCollisions() {
            // Bullet-ball collisions
            bullets.forEach((bullet, bulletIndex) => {
                balls.forEach(ball => {
                    const dist = Math.sqrt(
                        Math.pow(bullet.x - ball.x, 2) + 
                        Math.pow(bullet.y - ball.y, 2)
                    );
                    
                    if (dist < ball.radius) {
                        bullets.splice(bulletIndex, 1);
                        splitBall(ball, bullet.explosive);
                    }
                });
            });
            
            // Player-ball collisions
            if (!shieldActive) {
                balls.forEach(ball => {
                    const playerCenterX = player.x + player.width / 2;
                    const playerCenterY = player.y + player.height / 2;
                    const dist = Math.sqrt(
                        Math.pow(playerCenterX - ball.x, 2) + 
                        Math.pow(playerCenterY - ball.y, 2)
                    );
                    
                    if (dist < ball.radius + 15) {
                        playerHit();
                    }
                });
            }
            
            // Player-powerup collisions
            powerups.forEach((powerup, index) => {
                if (player.x < powerup.x + powerup.width &&
                    player.x + player.width > powerup.x &&
                    player.y < powerup.y + powerup.height &&
                    player.y + player.height > powerup.y) {
                    applyPowerup(powerup.type);
                    powerups.splice(index, 1);
                }
            });
        }
        
        // Player hit
        function playerHit() {
            lives--;
            updateHUD();
            
            if (lives <= 0) {
                gameOver();
            } else {
                // Reset player position
                player.x = canvas.width / 2 - 15;
                player.y = canvas.height - 100;
                player.vx = 0;
                player.vy = 0;
                
                // Temporary invincibility
                shieldActive = true;
                setTimeout(() => {
                    if (activePowerup !== 'SHIELD') {
                        shieldActive = false;
                    }
                }, 2000);
            }
        }
        
        // Level complete
        function levelComplete() {
            playSound('levelComplete');
            levelStarted = false;
            level++;
            
            if (level > 20) {
                gameWon = true;
                gameOver();
                return;
            }
            
            // Show level complete message
            setTimeout(() => {
                createLevel();
            }, 2000);
        }
        
        // Game over
        function gameOver() {
            gameRunning = false;
            playSound('gameOver');
            totalGameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            
            // Update high score
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('zkPangHighScore', highScore);
            }
            
            // Hide game elements
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('gameHUD').style.display = 'none';
            document.getElementById('fullscreenBtn').style.display = 'none';
            document.getElementById('soundBtn').style.display = 'none';
            if (document.getElementById('mobileControls')) {
                document.getElementById('mobileControls').style.display = 'none';
            }
            
            showGameOver();
        }
        
        // Show game over screen
        function showGameOver() {
            const gameOverScreen = document.getElementById('gameOverScreen');
            const title = document.getElementById('gameOverTitle');
            
            if (gameWon) {
                title.textContent = 'üéâ VICTORY! üéâ';
                title.style.color = '#2ecc71';
            } else {
                title.textContent = 'GAME OVER';
                title.style.color = '#e94560';
            }
            
            const minutes = Math.floor(totalGameTime / 60);
            const seconds = totalGameTime % 60;
            const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('finalScore').innerHTML = `üéØ Final Score: ${score.toLocaleString()}`;
            document.getElementById('finalLevel').innerHTML = `üåç Level Reached: ${level}/20`;
            document.getElementById('finalTime').innerHTML = `‚è±Ô∏è Time: ${timeStr}`;
            
            gameOverScreen.style.display = 'block';
        }
        
        // Update HUD
        function updateHUD() {
            document.getElementById('scoreDisplay').textContent = score.toLocaleString();
            document.getElementById('levelDisplay').textContent = `${level}/20`;
            document.getElementById('livesDisplay').textContent = '‚ù§Ô∏è'.repeat(lives);
            document.getElementById('ammoDisplay').textContent = player.ammo === Infinity ? '‚àû' : player.ammo;
        }
        
        // Check power-up expiration
        function checkPowerupExpiration() {
            if (activePowerup && Date.now() > powerupEndTime) {
                switch(activePowerup) {
                    case 'SLOW_TIME':
                        slowTimeMultiplier = player.id === 4 ? 0.7 : 1;
                        break;
                    case 'RAPID_FIRE':
                        player.shootCooldown = player.id === 3 ? 150 : 300;
                        break;
                    case 'SHIELD':
                        shieldActive = false;
                        break;
                    case 'DOUBLE_POINTS':
                        scoreMultiplier = player.id === 5 ? 2 : 1;
                        break;
                    case 'EXPLOSIVE':
                        explosiveBullets = false;
                        break;
                }
                activePowerup = null;
            }
            
            if (frozenBalls && Date.now() > frozenEndTime) {
                frozenBalls = false;
                balls.forEach(ball => ball.frozen = false);
            }
        }
        
        // Game loop
        function gameLoop() {
            if (!gameRunning || isPaused) return;
            
            // Clear canvas
            ctx.fillStyle = WORLDS[currentWorld].background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw background image if loaded
            if (backgroundImage && backgroundImage.complete) {
                ctx.globalAlpha = 0.3;
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1;
            }
            
            // Update and draw platforms
            platforms.forEach(platform => platform.draw());
            
            // Update and draw player
            player.update();
            player.draw();
            
            // Update and draw balls
            balls.forEach(ball => {
                ball.update();
                ball.draw();
            });
            
            // Update and draw bullets
            bullets = bullets.filter(bullet => bullet.y > 0);
            bullets.forEach(bullet => {
                bullet.update();
                bullet.draw();
            });
            
            // Update and draw powerups
            powerups = powerups.filter(powerup => !powerup.collected);
            powerups.forEach(powerup => {
                powerup.update();
                powerup.draw();
            });
            
            // Update particles
            updateParticles();
            
            // Check collisions
            checkCollisions();
            
            // Check power-up expiration
            checkPowerupExpiration();
            
            // Draw level info
            if (!levelStarted) {
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Orbitron';
                ctx.textAlign = 'center';
                ctx.fillText(`Level ${level}`, canvas.width / 2, canvas.height / 2);
                ctx.font = '24px Orbitron';
                ctx.fillText(WORLDS[currentWorld].name, canvas.width / 2, canvas.height / 2 + 40);
            }
            
            // Draw active power-up indicator
            if (activePowerup) {
                const timeLeft = Math.ceil((powerupEndTime - Date.now()) / 1000);
                ctx.fillStyle = POWERUP_TYPES[activePowerup].color;
                ctx.font = 'bold 20px Orbitron';
                ctx.textAlign = 'left';
                ctx.fillText(`${POWERUP_TYPES[activePowerup].symbol} ${timeLeft}s`, 10, canvas.height - 20);
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Fullscreen toggle
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // Sound toggle button
        function toggleSoundButton() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').textContent = soundEnabled ? 'üîä Sound' : 'üîá Muted';
        }
        
        // Share on Twitter
        function shareOnTwitter() {
            const minutes = Math.floor(totalGameTime / 60);
            const seconds = totalGameTime % 60;
            const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            let tweetText = `üéÆ I scored ${score.toLocaleString()} points in ZK Proof Pang!\n\n`;
            tweetText += `üìä Score: ${score.toLocaleString()}\n`;
            tweetText += `üéØ Level: ${level}/20\n`;
            tweetText += `‚è±Ô∏è Time: ${timeStr}\n`;
            tweetText += `üåç World: ${WORLDS[currentWorld].name}\n\n`;
            
            if (gameWon) {
                tweetText = `üèÜ I completed all 20 levels in ZK Proof Pang!\n\n` + tweetText;
            }
            
            tweetText += `Play now! üëá`;
            
            const gameUrl = 'https://zk-proof-pang.vercel.app';
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(gameUrl)}&hashtags=ZKProofPang,Web3Gaming`;
            
            window.open(twitterUrl, '_blank');
        }
    </script>
</body>
</html>
